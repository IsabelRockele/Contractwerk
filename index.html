<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contractbord – Start</title>

  <!-- Vormgeving -->
  <link rel="stylesheet" href="contract_style.css">

  <!-- PWA (optioneel, laat staan als u dit gebruikt) -->
  <link rel="manifest" href="contract_manifest.json">
  <link rel="icon" href="pictogram-192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="pictogram-512x512.png">
</head>
<body class="startscherm">

  <div class="bovenbalk">
    <div class="titelvak">
      <div class="titel-plek" aria-hidden="true"></div>
      <div class="bord-info">
        <span>Contractbord</span>
        <small>Start</small>
      </div>
    </div>
  </div>

  <main class="kaart">
    <!-- Rolkeuze -->
    <section id="rolKeuze">
      <h2 style="margin-top:0">Kies je rol</h2>
      <div class="rollen">
        <button id="btnNaarLeerkracht" class="rol rol-leerkracht">Leerkracht</button>
        <button id="btnNaarKind" class="rol rol-kind rol-met-beeld" aria-label="Kind">
          <img src="contract_afbeeldingen/kind.png" alt="" class="rol-afbeelding">
        </button>
      </div>
    </section>

    <!-- Leerkracht: login -->
    <section id="leerkrachtLogin" class="verborgen">
      <button id="btnTerugLogin" class="terug" aria-label="Terug naar rolkeuze">← Terug</button>

      <form id="loginForm" class="loginkaart" autocomplete="on">
        <h3 style="margin-top:0">Inloggen leerkracht</h3>
        <p style="margin:.25rem 0 .75rem">Gebruik dezelfde inlog als in de <strong>huiswerkapp</strong>.</p>

        <div class="formgroep">
          <label for="email">E-mail</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="email" required>
        </div>

        <div class="formgroep">
          <label for="password">Wachtwoord</label>
          <input id="password" name="password" type="password" autocomplete="current-password" required>
        </div>

        <div class="formopties">
          <label class="checklabel">
            <input id="rememberEmail" type="checkbox" checked>
            <span>E-mail onthouden op dit toestel</span>
          </label>
          <small>Tip: laat je browser het wachtwoord bewaren; dan staat alles de volgende keer al ingevuld.</small>
        </div>

        <div class="formknoppen">
          <button type="submit" class="prim">Log in</button>
          <button type="button" id="toonRegistratie" class="sec">Geen inlog? Registreer hier</button>
          <button type="button" id="gaNaarBord" class="sec" title="Open bord als je al ingelogd bent">Open bord</button>
        </div>

        <p id="loginFout" class="foutmelding" aria-live="polite" hidden></p>
      </form>
    </section>

    <!-- Leerkracht: registreren -->
    <section id="leerkrachtRegister" class="verborgen">
      <button id="btnTerugRegister" class="terug" aria-label="Terug naar inloggen">← Terug</button>

      <form id="registerForm" class="loginkaart" autocomplete="on">
        <h3 style="margin-top:0">Registreren</h3>
        <p style="margin:.25rem 0 .75rem">Maak hier je account aan. Deze inlog werkt ook in de <strong>huiswerkapp</strong>.</p>

        <div class="formgroep">
          <label for="regEmail">E-mail</label>
          <input id="regEmail" name="regEmail" type="email" inputmode="email" autocomplete="email" required>
        </div>

        <div class="formgroep">
          <label for="regPassword">Wachtwoord</label>
          <input id="regPassword" name="regPassword" type="password" autocomplete="new-password" required>
        </div>

        <div class="formknoppen">
          <button type="submit" class="prim">Account aanmaken</button>
          <button type="button" id="gaNaarLogin" class="sec">Ik heb al een account</button>
        </div>

        <p id="regFout" class="foutmelding" aria-live="polite" hidden></p>
      </form>
    </section>

    <!-- Kind: leerkracht-code (indien geen QR) -->
    <dialog id="kindDialog">
      <form id="kindForm" method="dialog" class="loginkaart" autocomplete="on">
        <h3>Kind – leerkrachtcode</h3>
        <div class="formgroep">
          <label for="leerkrachtUid">Leerkracht-ID</label>
          <input id="leerkrachtUid" name="username" type="text" autocomplete="username" placeholder="Scan QR of vul code in" required>
        </div>
        <div class="formknoppen">
          <button type="submit" class="prim">Ga verder</button>
          <button type="button" id="kindAnnuleer" class="sec">Annuleer</button>
        </div>
        <small>We onthouden deze code voor volgende keer.</small>
      </form>
    </dialog>
  </main>

  <!-- Firebase + logica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA7KxXMvZ4dzBQDut3CMyWUblLte2tFzoQ",
      authDomain: "huiswerkapp-a311e.firebaseapp.com",
      projectId: "huiswerkapp-a311e",
      storageBucket: "huiswerkapp-a311e.appspot.com",
      messagingSenderId: "797169941164",
      appId: "1:797169941164:web:511d9618079f1378d0fd09"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // UI refs
    const rolKeuze         = document.getElementById('rolKeuze');
    const btnNaarLeerkracht= document.getElementById('btnNaarLeerkracht');
    const btnNaarKind      = document.getElementById('btnNaarKind');

    const leerkrachtLogin  = document.getElementById('leerkrachtLogin');
    const loginForm        = document.getElementById('loginForm');
    const emailEl          = document.getElementById('email');
    const passEl           = document.getElementById('password');
    const rememberEl       = document.getElementById('rememberEmail');
    const loginFout        = document.getElementById('loginFout');
    const gaNaarBordBtn    = document.getElementById('gaNaarBord');
    const btnTerugLogin    = document.getElementById('btnTerugLogin');
    const toonRegLink      = document.getElementById('toonRegistratie');

    const leerkrachtRegister = document.getElementById('leerkrachtRegister');
    const registerForm     = document.getElementById('registerForm');
    const regEmailEl       = document.getElementById('regEmail');
    const regPassEl        = document.getElementById('regPassword');
    const regFout          = document.getElementById('regFout');
    const btnTerugRegister = document.getElementById('btnTerugRegister');
    const gaNaarLoginBtn   = document.getElementById('gaNaarLogin');

    const kindDialog       = document.getElementById('kindDialog');
    const kindForm         = document.getElementById('kindForm');
    const kindAnnuleerBtn  = document.getElementById('kindAnnuleer');
    const leerkrachtUidEl  = document.getElementById('leerkrachtUid');

    // Prefill e-mail indien onthouden
    const savedEmail = localStorage.getItem('contract_leerkracht_email');
    if (savedEmail) emailEl.value = savedEmail;

    // Status van login voor "Open bord"
    onAuthStateChanged(auth, (user) => {
      gaNaarBordBtn.disabled = !user;
    });

    // Navigatie rol → login
    btnNaarLeerkracht.addEventListener('click', () => {
      rolKeuze.classList.add('verborgen');
      leerkrachtRegister.classList.add('verborgen');
      leerkrachtLogin.classList.remove('verborgen');
      setTimeout(()=>emailEl.focus(), 50);
    });
    btnTerugLogin.addEventListener('click', () => {
      leerkrachtLogin.classList.add('verborgen');
      rolKeuze.classList.remove('verborgen');
    });

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginFout.hidden = true;
      try {
        await setPersistence(auth, browserLocalPersistence);
        const email = emailEl.value.trim();
        const pass  = passEl.value;
        if (rememberEl.checked) localStorage.setItem('contract_leerkracht_email', email);
        else localStorage.removeItem('contract_leerkracht_email');
        await signInWithEmailAndPassword(auth, email, pass);
        location.href = 'contract_board.html?rol=leerkracht';
      } catch (err) {
        loginFout.textContent = netteAuthFout(err);
        loginFout.hidden = false;
      }
    });

    // Registratie tonen
    toonRegLink.addEventListener('click', () => {
      leerkrachtLogin.classList.add('verborgen');
      leerkrachtRegister.classList.remove('verborgen');
      setTimeout(()=>regEmailEl.focus(), 50);
    });
    btnTerugRegister.addEventListener('click', () => {
      leerkrachtRegister.classList.add('verborgen');
      leerkrachtLogin.classList.remove('verborgen');
    });
    gaNaarLoginBtn.addEventListener('click', () => {
      leerkrachtRegister.classList.add('verborgen');
      leerkrachtLogin.classList.remove('verborgen');
      setTimeout(()=>emailEl.focus(), 50);
    });

    // Registreren
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      regFout.hidden = true;
      try {
        await setPersistence(auth, browserLocalPersistence);
        const email = regEmailEl.value.trim();
        const pass  = regPassEl.value;
        await createUserWithEmailAndPassword(auth, email, pass);
        // Klaar: meteen naar bord
        location.href = 'contract_board.html?rol=leerkracht';
      } catch (err) {
        regFout.textContent = netteAuthFout(err);
        regFout.hidden = false;
      }
    });

    // Open bord (als je al ingelogd bent)
    gaNaarBordBtn.addEventListener('click', () => {
      location.href = 'contract_board.html?rol=leerkracht';
    });

    // Kindmodus: anoniem + QR of manueel UID
    btnNaarKind.addEventListener('click', async () => {
      try { await signInAnonymously(auth); } catch {}
      const viaQr = new URLSearchParams(location.search).get('lid');
      const lid = viaQr || localStorage.getItem('contract_leerkracht_uid') || '';
      if (viaQr) {
        location.href = `contract_board.html?rol=kind&lid=${encodeURIComponent(viaQr)}`;
      } else {
        leerkrachtUidEl.value = lid;
        kindDialog.showModal();
      }
    });
    kindAnnuleerBtn.addEventListener('click', ()=>kindDialog.close());
    kindForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const lid = leerkrachtUidEl.value.trim();
      if (!lid) return;
      localStorage.setItem('contract_leerkracht_uid', lid);
      location.href = `contract_board.html?rol=kind&lid=${encodeURIComponent(lid)}`;
    });

    // Service worker (optioneel)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }

    // Vriendelijke foutteksten
    function netteAuthFout(err){
      const code = (err && err.code) ? String(err.code) : '';
      switch (code) {
        case 'auth/invalid-email': return 'Dit e-mailadres is ongeldig.';
        case 'auth/user-disabled': return 'Dit account is uitgeschakeld.';
        case 'auth/user-not-found': return 'Geen account gevonden. Registreer eerst.';
        case 'auth/wrong-password': return 'Onjuist wachtwoord.';
        case 'auth/weak-password': return 'Wachtwoord is te zwak (kies zeker 6 tekens).';
        case 'auth/email-already-in-use': return 'Dit e-mailadres is al in gebruik.';
        default: return err?.message || 'Er ging iets mis. Probeer opnieuw.';
      }
    }
  </script>
</body>
</html>



